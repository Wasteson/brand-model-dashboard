-- üîç Lookup for landnavn, med override for country_code = 0 ‚Üí Denmark
WITH country_lookup AS (
  SELECT
    country_code,
    CASE
      WHEN country_code = 0 THEN 'Denmark'
      ELSE comment
    END AS country_full
  FROM `imposing-yen-426717-u4.enum_lookup_tables.countries`
),

-- üì¶ Mobile.de + AutoScout, bruktfilter
base_data AS (
  -- Mobile.de
  SELECT
    'mobile' AS source,
    IFNULL(sellerCountry, 51) AS country_code,
    make AS brand,
    sourceModel AS model                          -- <‚Äì endret
  FROM `imposing-yen-426717-u4.mobile.staging_mobile_prod`
  WHERE make IS NOT NULL
    AND sourceModel IS NOT NULL                   -- <‚Äì endret
    AND (firstRegistration IS NOT NULL OR mileage > 100)
  
  UNION ALL
  
  -- AutoScout24
  SELECT
    'autoscout' AS source,
    sellerCountry AS country_code,
    make AS brand,
    model                                         -- uendret
  FROM `imposing-yen-426717-u4.autoscout.staging_autoscout_prod`
  WHERE make IS NOT NULL
    AND model IS NOT NULL
    AND (firstRegistration IS NOT NULL OR mileage > 100)
),

-- üì¶ Bilinfo (DK, bruktbiler)
bilinfo_data AS (
  SELECT
    'bilinfo' AS source,
    0 AS country_code,
    make        AS brand,                         -- lowercase i nytt schema
    sourceModel AS model                          -- <‚Äì endret
  FROM `imposing-yen-426717-u4.bilinfo.prod_bilinfo_prod`
  WHERE make        IS NOT NULL
    AND sourceModel IS NOT NULL                   -- <‚Äì endret
    AND Mileage     > 100
),

-- üì¶ Kombiner alle datakilder
all_data AS (
  SELECT * FROM base_data
  UNION ALL
  SELECT * FROM bilinfo_data
),

-- üì¶ Aggreger per brand/model/land
brand_model_counts AS (
  SELECT
    country_code,
    UPPER(TRIM(brand)) AS brand,
    UPPER(TRIM(model)) AS model,
    COUNT(*) AS num_ads
  FROM all_data
  GROUP BY country_code, brand, model
),

-- üì¶ Totalannonser per land
total_per_country AS (
  SELECT
    country_code,
    SUM(num_ads) AS total_ads
  FROM brand_model_counts
  GROUP BY country_code
),

-- üì¶ Sluttresultat
final AS (
  SELECT
    bmc.country_code,
    cl.country_full,
    bmc.brand,
    bmc.model,
    bmc.num_ads,
    tpc.total_ads
  FROM brand_model_counts bmc
  JOIN total_per_country tpc USING (country_code)
  JOIN country_lookup  cl  USING (country_code)
  WHERE tpc.total_ads >= 1000
)

-- üì¶ Output
SELECT *
FROM final
ORDER BY total_ads DESC, country_full, num_ads DESC;
